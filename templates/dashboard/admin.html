{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3>Admin Dashboard</h3>
  <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
</div>

<!-- Coupon Table -->
<h4 class="mt-3">All Coupons</h4>
<table class="table table-hover table-bordered">
  <thead class="table-dark">
    <tr>
      <th>Code</th>
      <th>Discount</th>
      <th>Status</th>
      <th>Scanned</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for c in coupons %}
      <tr>
        <td>{{ c.code }}</td>
        <td>{{ c.discount }}%</td>
        <td>{{ c.status }}</td>
        <td>{{ c.scanned_count }}</td>
        <td>
          {% if c.status != 'approved' %}
            <button class="btn btn-sm btn-success approveBtn" data-code="{{ c.code }}">Approve</button>
          {% endif %}
          {% if c.status != 'rejected' %}
            <button class="btn btn-sm btn-danger rejectBtn" data-code="{{ c.code }}">Reject</button>
          {% endif %}
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('view_coupon', code=c.code) }}">View</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- User Management Section -->
<h4 class="mt-5">User Management</h4>
<table class="table table-striped table-bordered">
  <thead class="table-dark">
    <tr>
      <th>Username</th>
      <th>Email</th>
      <th>Role</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for u in users %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{{ u.email }}</td>
        <td>
          <form method="post" action="{{ url_for('change_role') }}" class="d-flex">
            <!-- Hidden User ID -->
            <input type="hidden" name="user_id" value="{{ u.id }}">
            
            <select name="role" class="form-select form-select-sm me-2">
              <option value="user" {% if u.role == 'user' %}selected{% endif %}>User</option>
              <option value="vendor" {% if u.role == 'vendor' %}selected{% endif %}>Vendor</option>
              <option value="sponsor" {% if u.role == 'sponsor' %}selected{% endif %}>Sponsor</option>
              <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Admin</option>
            </select>
            <button type="submit" class="btn btn-sm btn-primary">Update</button>
          </form>
        </td>
        <td>
          <!-- Change Password Modal Trigger -->
          <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal{{ u.id }}">
            Change Password
          </button>

          <!-- Change Password Modal -->
          <div class="modal fade" id="changePasswordModal{{ u.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="post" action="{{ url_for('change_password') }}">
                  <div class="modal-header">
                    <h5 class="modal-title">Change Password for {{ u.username }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <!-- Hidden User ID -->
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    
                    <div class="mb-3">
                      <label>New Password</label>
                      <input type="password" name="new_password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                      <label>Confirm Password</label>
                      <input type="password" name="confirm_password" class="form-control" required>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
